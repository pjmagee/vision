using Microsoft.Extensions.Logging;
using System;
using System.Linq;
using System.Threading.Tasks;

namespace Vision.Core
{
    public class VulnerabilityService : IVulnerabilityService
    {
        private readonly ILogger<VulnerabilityService> logger;
        private VisionDbContext context;

        public VulnerabilityService(ILogger<VulnerabilityService> logger, VisionDbContext context)
        {
            this.logger = logger;
            this.context = context;
        }

        public async Task<IPaginatedList<VulnerabilityReportDto>> GetByDependencyIdAsync(Guid dependencyId, int pageIndex = 1, int pageSize = 10)
        {
            return await PaginatedList<VulnerabilityReportDto>.CreateAsync(context.Vulnerabilities
               .Where(x => x.DependencyVersion.DependencyId == dependencyId)
               .Select(report => new VulnerabilityReportDto
               {
                   Version = report.DependencyVersion.Version,
                   CheckTime = report.CheckTime,
                   DependencyId = report.DependencyVersion.DependencyId,
                   DependencyVersionId = report.DependencyVersionId,
                   Link = report.Link,
                   ReporterKind = report.Kind,
                   ResponseData = report.ResponseData
               }),
               pageIndex, pageSize);
        }

        public async Task<IPaginatedList<VulnerabilityReportDto>> GetByDependencyVersionIdAsync(Guid dependencyVersionId, int pageIndex = 1, int pageSize = 10)
        {
            return await PaginatedList<VulnerabilityReportDto>.CreateAsync(context.Vulnerabilities
                .Where(x => x.DependencyVersionId == dependencyVersionId)
                .Select(report => new VulnerabilityReportDto
                {
                    CheckTime = report.CheckTime,
                    Version = report.DependencyVersion.Version,
                    DependencyId = report.DependencyVersion.DependencyId,
                    DependencyVersionId = dependencyVersionId,
                    Link = report.Link,
                    ReporterKind = report.Kind,
                    ResponseData = report.ResponseData
                }),
                pageIndex, pageSize);
        }

        public async Task<IPaginatedList<VulnerabilityReportDto>> GetByEcosystemKindAsync(EcosystemKind kind, int pageIndex = 1, int pageSize = 10)
        {
            return await PaginatedList<VulnerabilityReportDto>.CreateAsync(context.Vulnerabilities
                .Where(x => x.DependencyVersion.Dependency.Kind == kind)
                .Select(report => new VulnerabilityReportDto
                {
                    CheckTime = report.CheckTime,
                    Version = report.DependencyVersion.Version,
                    DependencyId = report.DependencyVersion.DependencyId,
                    DependencyVersionId = report.DependencyVersion.Id,
                    Link = report.Link,
                    ReporterKind = report.Kind,
                    ResponseData = report.ResponseData
                }),
                pageIndex, pageSize);
        }
    }
}